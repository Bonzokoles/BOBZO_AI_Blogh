---
/**
 * Bonzo Interactive Avatar - HeyGen Streaming
 * Live talking avatar for PORTA door sales
 */
import Layout from "@layouts/Layout.astro";
import PageHeader from "@components/Astro/PageHeader.astro";
import coverImage from "@assets/alk-cover-2.webp";
---

<Layout
  title="Bonzo - Interaktywny Awatar Sprzedawca"
  description="Poznaj Bonzo - ≈ºywy awatar AI sprzedajƒÖcy drzwi PORTA. Rozmawia g≈Çosem i rusza siƒô w czasie rzeczywistym!"
>
  <PageHeader
    heading="Bonzo - Tw√≥j ≈ªywy Ekspert od Drzwi PORTA"
    description="Interaktywny awatar 3D z pe≈ÇnƒÖ wiedzƒÖ o drzwiach PORTA. Rozmawia g≈Çosem i odpowiada na pytania!"
    image={coverImage}
    imageAlt="Bonzo AI - ≈ªywy Awatar"
    animate={true}
  />

  <!-- HeyGen Streaming Avatar SDK -->
  <script src="https://unpkg.com/@heygen/streaming-avatar@1.1.0/dist/index.umd.js" is:inline></script>

  <section class="container mx-auto px-4 py-12">
    <div class="max-w-6xl mx-auto">
      <div class="grid md:grid-cols-2 gap-8">
        <!-- Presentation Video Section -->
        <div>
          <div class="video-container rounded-xl overflow-hidden shadow-2xl bg-gray-900 relative">
            <video
              id="presentation-video"
              class="w-full aspect-video object-cover"
              controls
              autoplay
              muted
              loop
              poster="https://pub-25059caf15274ebd844548094bfb4dc1.r2.dev/alk4.png"
            >
              <source
                src="https://pub-25059caf15274ebd844548094bfb4dc1.r2.dev/DRZWI_DRZWI.mp4"
                type="video/mp4"
              />
              Twoja przeglƒÖdarka nie obs≈Çuguje wideo HTML5.
            </video>
          </div>
          <p class="text-center text-sm text-gray-600 dark:text-gray-400 mt-3">
            üé¨ Prezentacja Bonzo - Poznaj eksperta od drzwi PORTA
          </p>
        </div>

        <!-- Interactive Avatar Section -->
        <div>
          <div class="avatar-container rounded-xl overflow-hidden shadow-2xl bg-gray-900 relative">
            <video
              id="avatar-video"
              class="w-full aspect-video object-cover"
              autoplay
              playsinline
            ></video>
            <div id="avatar-status" class="absolute top-4 left-4 bg-black bg-opacity-80 text-white px-4 py-2 rounded-full flex items-center gap-2 text-sm">
              <div class="status-dot"></div>
              <span id="status-text">≈Åadowanie awatara...</span>
            </div>
          </div>
          <p class="text-center text-sm text-gray-600 dark:text-gray-400 mt-3">
            üé≠ Interaktywny Awatar - Kliknij poni≈ºej i rozmawiaj!
          </p>
        </div>
      </div>

      <!-- Chat Interface - Full Width Below Videos -->
      <div class="mt-8">
        <div class="flex flex-col">
          <div class="chat-container bg-gray-100 dark:bg-gray-800 rounded-xl p-6 shadow-xl flex-1 flex flex-col">
            <h2 class="text-2xl font-bold mb-4 text-center">Czat z Bonzo</h2>

            <p class="text-center mb-4 text-gray-600 dark:text-gray-300 text-sm">
              Zadaj pytanie - Bonzo odpowie g≈Çosem przez interaktywnego awatara po prawej! üëÜ
            </p>

            <div id="chat-messages" class="flex-1 overflow-y-auto mb-4 space-y-3 max-h-96">
              <div class="message-bot">
                <div class="text-xs font-semibold text-blue-600 dark:text-blue-400 mb-1">Bonzo:</div>
                <div class="bg-blue-50 dark:bg-blue-900 p-3 rounded-lg text-sm">
                  Cze≈õƒá! Jestem Bonzo, Tw√≥j ≈ºywy ekspert od drzwi PORTA. üëã<br><br>
                  Mamy 5 ≈õwietnych modeli - od stylowych FOCUS PREMIUM (od 1033 PLN) po eleganckie VERTE HOME.<br><br>
                  Zapytaj mnie o ceny, parametry lub pomoc w wyborze!
                </div>
              </div>
            </div>

            <div class="chat-input flex gap-2">
              <input
                type="text"
                id="user-input"
                placeholder="Zapytaj o drzwi PORTA..."
                class="flex-1 px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
                autocomplete="off"
              />
              <button
                id="send-btn"
                class="px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white rounded-lg font-semibold transition-all duration-200 shadow-lg"
              >
                Wy≈õlij
              </button>
            </div>

            <div class="mt-3 flex flex-wrap gap-2 justify-center">
              <button class="example-btn" data-question="Jakie masz modele?">Modele</button>
              <button class="example-btn" data-question="Ile kosztuje FOCUS PREMIUM?">Ceny</button>
              <button class="example-btn" data-question="Kt√≥re drzwi majƒÖ szk≈Ço?">Ze szk≈Çem</button>
              <button class="example-btn" data-question="Jak zam√≥wiƒá?">Zam√≥wienie</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Knowledge Base Cards -->
      <div class="mt-12 grid md:grid-cols-3 gap-6">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg">
          <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
            <span class="text-2xl">üìã</span> Modele PORTA
          </h3>
          <ul class="space-y-2 text-sm text-gray-700 dark:text-gray-300">
            <li>‚úÖ FOCUS PREMIUM 5.A</li>
            <li>‚úÖ FACTOR 5</li>
            <li>‚úÖ DESIRE 5</li>
            <li>‚úÖ ART DECO 5</li>
            <li>‚úÖ VERTE HOME H.5</li>
          </ul>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg">
          <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
            <span class="text-2xl">üí∞</span> Ceny
          </h3>
          <ul class="space-y-2 text-sm text-gray-700 dark:text-gray-300">
            <li>FOCUS PREMIUM: od 1033 PLN</li>
            <li>FACTOR: od 629 PLN</li>
            <li>Inne: cena po kontakcie</li>
          </ul>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-lg">
          <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
            <span class="text-2xl">üìû</span> Kontakt
          </h3>
          <ul class="space-y-2 text-sm text-gray-700 dark:text-gray-300">
            <li>Tel: 790 645 410</li>
            <li>Dostƒôpno≈õƒá: po 23:00 w ≈õrodƒô</li>
          </ul>
        </div>
      </div>
    </div>
  </section>
</Layout>

<style>
  .status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #fbbf24;
    animation: pulse 2s infinite;
  }

  .status-dot.ready {
    background: #10b981;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  .message-bot, .message-user {
    animation: slideIn 0.3s ease-out;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .example-btn {
    padding: 8px 16px;
    background: white;
    dark:bg-gray-700;
    border: 1px solid #e0e0e0;
    rounded: 8px;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .example-btn:hover {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-color: transparent;
    transform: translateY(-2px);
  }

  #chat-messages::-webkit-scrollbar {
    width: 6px;
  }

  #chat-messages::-webkit-scrollbar-track {
    background: transparent;
  }

  #chat-messages::-webkit-scrollbar-thumb {
    background: #cbd5e0;
    border-radius: 3px;
  }
</style>

<script>
  // HeyGen Configuration
  const HEYGEN_API_KEY = import.meta.env.PUBLIC_HEYGEN_API_KEY || 'YjI5ZmI5NzMwYmRiNDVhNzk4ZTA3ZmNhNzBhNmI2YzEtMTczMDMzNTgwMg==';
  const AVATAR_ID = 'Wayne_20240711';
  const VOICE_ID = '30e127089cf14adfad2d8d2eed5e3efe'; // Polish male

  // PORTA Knowledge Base
  const KNOWLEDGE_BASE = `PORTA Drzwi: 1.FOCUS PREMIUM 5.A od 1033 PLN 2.FACTOR 5 od 629 PLN 3.DESIRE 5 4.ART DECO 5 5.VERTE HOME H.5. Kontakt: 790 645 410 (po 23:00 ≈õroda)`;

  const SYSTEM_PROMPT = `Jeste≈õ Bonzo - sprzedawca drzwi PORTA. Odpowiadaj PO POLSKU, kr√≥tko (max 2-3 zdania), rzeczowo, z lekkim humorem. Znasz: ${KNOWLEDGE_BASE}`;

  // Global state
  let avatar = null;
  let sessionId = null;
  let isReady = false;

  // DOM
  const avatarVideo = document.getElementById('avatar-video') as HTMLVideoElement;
  const statusText = document.getElementById('status-text');
  const statusDot = document.querySelector('.status-dot');
  const chatMessages = document.getElementById('chat-messages');
  const userInput = document.getElementById('user-input') as HTMLInputElement;
  const sendBtn = document.getElementById('send-btn');
  const exampleBtns = document.querySelectorAll('.example-btn');

  // Initialize avatar
  document.addEventListener('DOMContentLoaded', initAvatar);

  async function initAvatar() {
    try {
      updateStatus('≈ÅƒÖczenie z awatarem...', false);

      // @ts-ignore - HeyGen SDK loaded via CDN
      avatar = new HeyGenStreamingAvatar.StreamingAvatar({
        apiKey: HEYGEN_API_KEY,
        videoElement: avatarVideo
      });

      const session = await avatar.createStartAvatar({
        avatarName: AVATAR_ID,
        voice: { voiceId: VOICE_ID, rate: 1.0, emotion: 'Friendly' },
        language: 'pl',
        quality: 'high'
      });

      sessionId = session.session_id;
      isReady = true;
      updateStatus('‚úÖ Bonzo gotowy!', true);

      await speak('Cze≈õƒá! Pytaj o drzwi PORTA!');
    } catch (err) {
      console.error('Avatar error:', err);
      updateStatus('‚ùå B≈ÇƒÖd awatara', false);
      addMessage('bot', 'Przepraszam, problem z po≈ÇƒÖczeniem. Od≈õwie≈º stronƒô.');
    }
  }

  async function sendMessage(text: string) {
    if (!text.trim() || !isReady) return;

    addMessage('user', text);
    userInput.value = '';
    sendBtn.disabled = true;

    try {
      const aiReply = await getAIResponse(text);
      addMessage('bot', aiReply);
      await speak(aiReply);
    } catch (err) {
      console.error('Send error:', err);
      addMessage('bot', 'Przepraszam, spr√≥buj ponownie.');
    } finally {
      sendBtn.disabled = false;
      userInput.focus();
    }
  }

  async function getAIResponse(message: string): Promise<string> {
    // Simple pattern matching fallback
    const lower = message.toLowerCase();

    if (lower.includes('model') || lower.includes('jaki')) {
      return 'Mamy 5 modeli: FOCUS PREMIUM (1033 PLN), FACTOR (629 PLN), DESIRE 5, ART DECO i VERTE HOME. Kt√≥ry Ciƒô interesuje?';
    }
    if (lower.includes('cena') || lower.includes('koszt') || lower.includes('ile')) {
      return 'FOCUS PREMIUM od 1033 PLN, FACTOR od 629 PLN. Pozosta≈Çe - cena po kontakcie. Tel: 790 645 410.';
    }
    if (lower.includes('szk≈Ço') || lower.includes('szyba')) {
      return 'FOCUS PREMIUM ma szk≈Ço hartowane 8mm. VERTE HOME - szyby matowe 4mm. Chcesz wiƒôcej info?';
    }
    if (lower.includes('zam√≥w') || lower.includes('kupiƒá') || lower.includes('kontakt')) {
      return 'Zadzwo≈Ñ: 790 645 410 (dostƒôpny po 23:00 w ≈õrodƒô). Chƒôtnie pomogƒô!';
    }

    return 'Pytaj o modele, ceny, parametry. Czego potrzebujesz?';
  }

  async function speak(text: string) {
    if (!avatar || !isReady) return;

    try {
      updateStatus('üó£Ô∏è Bonzo m√≥wi...', true);
      await avatar.speak({ text, taskType: 'talk', taskMode: 'async' });
      await new Promise(r => setTimeout(r, text.length * 50));
      updateStatus('‚úÖ Bonzo gotowy!', true);
    } catch (err) {
      console.error('Speak error:', err);
      updateStatus('‚úÖ Bonzo gotowy!', true);
    }
  }

  function addMessage(type: 'user' | 'bot', text: string) {
    const div = document.createElement('div');
    div.className = `message-${type}`;

    const sender = document.createElement('div');
    sender.className = `text-xs font-semibold mb-1 ${type === 'bot' ? 'text-blue-600 dark:text-blue-400' : 'text-green-600 dark:text-green-400'}`;
    sender.textContent = type === 'bot' ? 'Bonzo:' : 'Ty:';

    const bubble = document.createElement('div');
    bubble.className = `p-3 rounded-lg text-sm ${type === 'bot' ? 'bg-blue-50 dark:bg-blue-900' : 'bg-green-50 dark:bg-green-900'}`;
    bubble.textContent = text;

    div.appendChild(sender);
    div.appendChild(bubble);
    chatMessages?.appendChild(div);
    chatMessages?.scrollTo(0, chatMessages.scrollHeight);
  }

  function updateStatus(text: string, ready: boolean) {
    if (statusText) statusText.textContent = text;
    if (statusDot) {
      if (ready) statusDot.classList.add('ready');
      else statusDot.classList.remove('ready');
    }
  }

  // Event listeners
  sendBtn?.addEventListener('click', () => sendMessage(userInput.value));
  userInput?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage(userInput.value);
  });
  exampleBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const q = btn.getAttribute('data-question');
      if (q) {
        userInput.value = q;
        sendMessage(q);
      }
    });
  });

  // Cleanup
  window.addEventListener('beforeunload', async () => {
    if (avatar && sessionId) {
      try { await avatar.stopAvatar(); } catch (e) {}
    }
  });
</script>
